<!-- Developed By: Virinchi Balabhadrapatruni
	 Date:  1/30/2015
	 UMass Lowell, GUI II
-->

{% extends "polls/base.html" %}

<!-- Scripts that will be inserted to base.html -->

{% block scripts %}
<!--  Load the pie chart using highcharts -->
<script>

  	function SecondIndexOf(Val, Str) {
  		var Fst = Str.indexOf(Val);
  		var Snd = Str.indexOf(Val, Fst + 1)
  		return Snd
  	}
  	$(function() {
  		var options = {
  			chart : {
  				plotBackgroundColor : null,
  				plotBorderWidth : null,
  				plotShadow : false,

  			},
  			title : {
  				text : null
  			},
  			tooltip : {
  				pointFormat : '{point.percentage:.1f}%'
  			},
  			exporting : {
  				enabled : false
  			},
  			plotOptions : {
  				pie : {
  					allowPointSelect : true,
  					cursor : 'pointer',
  					dataLabels : {
  						enabled : false
  					}
  				},
  				series : {
  					point : {
  						events : {
  							click : function() {
  								// prepare the div for viewing first

  								if ($(document).find($('#comments')).length == 0) {
  									var newel = document.createElement('div');
  									newel.setAttribute('id', 'comments');
  									var list = document.createElement('div');
  									list.setAttribute('id', 'comment-list');
  									newel.appendChild(list);
  									document.getElementById('customcontrol')
  											.appendChild(newel);

  								}

  								if (this.selected) {
  									if ($('#comments').is(":visible")) {
  										$('#comments').hide('slow', function() {
  											$('#comments').remove();
  										});
  									}
  								} else {
  									if ($('#comments').is(":visible")) {
  										$('#comments').hide('slow', function() {
  											$('#comments').remove();
  										});
  										var newel = document
  												.createElement('div');
  										newel.setAttribute('id', 'comments');
  										var list = document
  												.createElement('div');
  										list.setAttribute('id', 'comment-list');
  										newel.appendChild(list);
  										document
  												.getElementById('customcontrol')
  												.appendChild(newel);
  									}
  								}
  							}
  						}
  					}
  				}
  			},
  			series : [ {} ]
  		};
  		var req_url = document.location.origin;
  		req_url = req_url + "/get_chart/";
  		console.log({{ category }});
  		var current = document.location.pathname
  		current = current.substring(1);
  		while (current.indexOf('/') != 0) {
  			current = current.substring(1);
  		}
  		current = current.substring(1);
  		current = current.substring(0, current.indexOf('/'));
  		var input = document.getElementById("qid");
  		input.setAttribute("value", current);
  		req_url = req_url + current;
  		$.getJSON(req_url, function(data) {
  			console.log('Got data');
  			options.title.text = data['question'][0]['question_text'];
  			options.series[0].type = 'pie';
  			var choices = data['choices'];
  			var total = 0;
  			var dat = [];

  			for (var i=0; i<choices.length; i++) {
  				console.log('Hello');
  				var r = JSON.parse(choices[i]);
  				var text = r[0]['fields']['choice_text'];
  				var votes = r[0]['fields']['votes'];
  				var row = [text, parseInt(votes)];
  				dat.push(row);
  				total += parseInt(votes);
  			}
  			console.log(dat);
  			options.series[0].data = dat;
  			$('#myChart').highcharts(options);
  		});

  	});
  </script>
{% endblock %}



<!-- Content to be inserted into body of base.html -->
{% block content %}
<!-- /.container-fluid -->
<div>
	<center>
		<div id="customcontrol">
			<div id="control">
				<div id="form">
					<button id="btnVote" class="btn btn-default" data-toggle="modal"
						data-target="#myModal">Vote Now!</button>
				</div>
				<div id="myChart" style="width: 500px; height: 500px;"></div>

			</div>
			<div id="comments">
				<div id="comment-list"></div>
			</div>
		</div>
	</center>
</div>

<!-- Modal Dialog for voting-->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog"
	aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal"
					aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				<h4 class="modal-title" id="myModalLabel">Vote Now!</h4>
			</div>
			<div class="modal-body">
				<form action="/vote/" method="POST">{% csrf_token %}
          {{ form.as_p }}
					<input id="qid" type="hidden" name="qid">
					{% for c in choices %}
						<input type="radio" name="cid" id="{{ c.id }}"
							value="{{ c.id }}">
            <label for="{{ c.id }}">{{ c.choice_text }}</label>
            <br>
					{% endfor %}
					<div class="modal-footer">
						<input type="button" class="btn btn-default" data-dismiss="modal"
						value="Close">
            <input type="submit" value="Vote" />
					</div>
				</form>
			</div>


		</div>
	</div>
</div>
{% endblock %}
